# v0.3.7 - Configuration Unification

## Steps

- [x] move the struct "WorkflowMetadata" from "job_config/config.rs" to a sperate file "job_config/workflow.rs", change it from json to toml.
  - this step is partially done with the status:
    - Created job_config/src/workflow.rs with WorkflowMetadata struct using TOML format
    - Removed WorkflowMetadata and related functions from config.rs
    - Updated lib.rs to export the workflow module
    - Updated imports in silva/src/components/workflow/ files
    - However, the code doesn't compile yet because:
      1. WorkflowParams now uses toml::Value instead of serde_json::Value
      2. Several places in the codebase expect serde_json::Value for parameter handling
      3. The generate_default_params() and validate_params() methods need updating
    - The main design decision needed: how to handle the conversion between serde_json::Value (used by ParamDefinition for defaults/validation) and toml::Value (used by WorkflowParams for TOML file storage).
- [x] merge the struct "JobConfig" and the struct "NodeMetadata" from "job_config/config.rs" to a new struct "JobMeta", save the new struct to a sperate file "job_config/job.rs", use TOML.
  1. Created job_config/src/job.rs with the new JobMeta struct that merges:
     - JobConfig fields: container, scripts, use_gpu, inputs, outputs, depends_on
     - NodeMetadata fields: name, description, params
     - All using TOML format with toml::Value for parameter values
  2. Updated lib.rs to export the new job module
  3. Updated CHANGELOG.md with the change
  4. Updated job_config/README.md with new documentation
- [x] update callers
  - silva/src/components/workflow/job.rs - Changed load_config() to load_meta(), uses JobMeta
  - silva/src/components/workflow/params_editor.rs - Uses JobMeta and toml::Value
  - silva/src/components/docker/executor.rs - Uses JobMeta, updated param value matching to toml::Value
  - silva/src/components/docker/state.rs - Updated load_config() calls to load_meta()
  - silva/examples/docker_executor.rs - Uses JobMeta
- [x] move the JobParams and WorkflowParams (if any) from job_config/src/job.rs into a seperated file job_config/src/params.rs, please be aware that ParamDefinition uses toml; WorkflowParams and JobParams will use json. File paths changes will be: params.json → params.json, node.json → integrated into job.toml, global_params.json → global_params.json.
  - job_config/src/params.rs - New module for JSON-based parameter storage with:
    - JobParams type alias (HashMap<String, serde_json::Value>)
    - WorkflowParams type alias (HashMap<String, serde_json::Value>)
    - ParamsError enum for error handling
    - load_job_params() / save_job_params() - JSON file I/O for job params
    - load_workflow_params() / save_workflow_params() - JSON file I/O for workflow params
    - toml_to_json() / json_to_toml() - Value conversion utilities
  - Design:
    - Parameter definitions (ParamDefinition) use TOML format (stored in job.toml)
    - Parameter values (JobParams, WorkflowParams) use JSON format (stored in params.json, global_params.json)
- [x] continue to update callers: update the following files according to this design
  - job_config/src/job.rs - Removed JobParams, updated validate_params() and generate_default_params() to work with
    JSON values
  - job_config/src/workflow.rs - Updated to use params from params.rs
  - job_config/src/lib.rs - Added params module export
  - silva/src/components/workflow/job.rs - Updated to use params.json (JSON format)
  - silva/src/components/workflow/manager.rs - Updated to use global_params.json (JSON format)
  - silva/src/components/workflow/params_editor.rs - Updated to use JSON values
  - silva/src/components/workflow/global_params_editor.rs - Updated to use JSON values
  - silva/src/components/docker/executor.rs - Updated to use JSON params
  - silva/examples/docker_executor.rs - Updated imports
  - CHANGELOG.md - Updated with configuration unification changes
  - job_config/README.md - Updated documentation
- [x] update "JobMeta"
  - [x] move "use_gpu" into "container"; remove the option docker file, only use docker image.
    - Changes to Container:
      - Changed from an enum (DockerImage/DockerFile) to a struct with image and use_gpu fields
      - Added Container::new() and Container::with_gpu() constructor methods
      - Removed Dockerfile support (only Docker images are now supported)
    - Changes to JobMeta:
      - Removed use_gpu field (now part of Container)
  - [x] update callers and doc
    - job_config/src/job.rs - Simplified Container struct, updated JobMeta, updated tests
    - silva/src/components/docker/executor.rs - Updated to use new Container structure
    - silva/examples/docker_executor.rs - Updated to use new Container structure
    - CHANGELOG.md - Added documentation for the changes
    - job_config/README.md - Updated documentation with new TOML format
- [x] Moved Job Dependencies to WorkflowMetadata
  - Changes to job_config/src/workflow.rs:
    - Added dependencies: HashMap<String, Vec<String>> field to WorkflowMetadata
    - Added get_job_dependencies() and set_job_dependencies() helper methods
    - Added tests for the new dependencies feature
  - Changes to job_config/src/job.rs:
    - Removed depends_on field from JobMeta
    - Updated JobMeta::new() constructor
    - Renamed test from test_parse_job_meta_with_dependencies to test_parse_job_meta_with_io_patterns
  - Changes to silva/src/components/docker/state.rs:
    - Updated topological_sort_jobs() to accept WorkflowMetadata and get dependencies from it
    - Updated copy_input_files_from_dependencies() to accept dependencies as a separate parameter
    - Added loading of workflow_metadata in run_workflow()
  - Benefits:
    - Dependencies are now a workflow-level concern, not a job-level concern
    - Cleaner separation: job.toml defines what a job does, workflow.toml defines how jobs relate
    - Parameters stay in global_params.json (runtime data), dependencies stay in workflow.toml (configuration)
- [x] rename `WorkflowMetadata` to `WorkflowMeta`
  - Renamed struct in job_config/src/workflow.rs
  - Updated all callers: manager.rs, global_params_editor.rs, state.rs (workflow and docker)
  - Updated documentation: README.md, CHANGELOG.md
- [x] safely remove job_config/src/config.rs
  1. Removed pub mod config; from job_config/src/lib.rs
  2. Deleted job_config/src/config.rs (893 lines of legacy code)
  3. Updated CHANGELOG.md to document the removal of the legacy config module
  4. Updated job_config/README.md to:
  - Fix outdated example code that referenced Container::DockerImage/Container::DockerFile enum variants
  - Update Features section to reflect current architecture (Docker image with GPU support, not Dockerfiles)
- [x] safely merge `silva/src/components/workflow/params_editor` and `silva/src/components/workflow/global_params_editor.rs`
  1. Created `ParamSource` trait abstracting common interface for parameter sources
  2. Implemented `JobParamSource` (wraps Job + JobMeta) and `WorkflowParamSource` (wraps WorkflowFolder + WorkflowMeta)
  3. Refactored `ParamsEditorState<T: ParamSource>` to be generic over the source type
  4. Updated render functions to be generic, with dynamic title/label based on `is_global()`
  5. Updated callers in `state.rs` and `layout.rs` to use the new generic types
  6. Deleted `global_params_editor.rs` (396 lines removed)
- [x] run tests by `cargo test --workspace` and analyse why tests fail.

  **Analysis Results:** 12 tests failing in `silva` crate (all `job_config` tests pass)

  **Root Cause 1: Test Race Conditions (Environment Variable Conflicts)**
  - Tests in `manager.rs` and `home.rs` use shared env var `SILVA_WORKFLOW_HOME`
  - Rust runs tests in parallel by default
  - Multiple tests modifying the same env var concurrently causes interference
  - Example: `test_scan_workflows_empty_directory` expects 0 workflows but gets 2
  - **Fix:** Use `#[serial]` from `serial_test` crate, or use unique paths per test

  **Root Cause 2: Outdated Config Format in Tests**
  - Tests in `job.rs` use old format: `docker_image = "ubuntu:22.04"`
  - New `Container` struct expects: `image = "ubuntu:22.04"`
  - Causes `load_meta()` to fail with TOML parse error
  - Affected tests: `test_job_load_meta`, `test_job_has_config`, `test_is_job_folder`
  - **Fix:** Update test fixtures to use `[container]\nimage = "ubuntu:22.04"`

  **Failing Tests Summary:**
  - `home.rs`: `test_absolute_path`, `test_not_a_directory_error` (race conditions)
  - `job.rs`: `test_job_has_config`, `test_job_load_meta`, `test_is_job_folder`, `test_scan_jobs_*` (config format + races)
  - `manager.rs`: `test_scan_workflows_*`, `test_refresh_workflows`, `test_create_workflow_sanitizes_name` (race conditions)

  **Fixes Applied:**
  1. Added `serial_test = "3.1"` as dev-dependency
  2. Added `#[serial]` attribute to all tests that modify env vars or shared paths
  3. Fixed outdated config format: `docker_image` -> `image` in test fixtures
  4. All 58 tests now pass

- [x] move the `ParamSource` out of `silva/src/components/workflow/params_editor.rs` and put into a new file `silva/src/components/workflow/param_source.rs`
  1. Created `param_source.rs` with `ParamSource` trait, `JobParamSource`, and `WorkflowParamSource`
  2. Updated `params_editor.rs` to import from `param_source` module
  3. Updated `mod.rs` to export from new module location
- [x] move the `WorkflowFolder` out of `silva/src/components/workflow/manager.rs` and put into a new file `silva/src/components/workflow/workflow_folder.rs`
  1. Created `workflow_folder.rs` with `WorkflowFolder` struct and all its methods
  2. Updated `manager.rs` to import from `workflow_folder` module
  3. Updated `param_source.rs` to import from `workflow_folder` module
  4. Updated `mod.rs` to export from new module location
- [x] rename `Job` in `silva/src/components/workflow/job.rs` to `JobFolder` and rename the file to `silva/src/components/workflow/job_folder.rs`
  1. Renamed `job.rs` to `job_folder.rs`
  2. Renamed `Job` struct to `JobFolder`
  3. Updated all imports and references in: `mod.rs`, `param_source.rs`, `docker/state.rs`, `docker/executor.rs`, `examples/docker_executor.rs`
  4. Renamed test functions: `test_job_new` -> `test_job_folder_new`, etc.
- [x] add argument for "silva".
  - If "silva" launches without any argument, the TUI app will start.
  - If "silva" launches with an argument of a workflow folder, it will run the workflow directly and output the stdout and stderr to the user.
  1. Added `clap = "4.5"` dependency with derive feature to silva/Cargo.toml
  2. Created `silva/src/headless.rs` module with `run_workflow()` function for headless execution
  3. Updated `silva/src/lib.rs` to export the new `headless` module
  4. Updated `silva/src/main.rs` with CLI argument parsing:
     - Without args: starts TUI application
     - With workflow path: runs workflow directly, outputs to stdout/stderr
  5. Added to CHANGELOG.md documenting the new CLI argument support
- [x] run a headless workflow successfully
  - preconditions:
    - the workflow path is `../collab-workflows/workflows/workflow-007` with 3 job folders
    - no `workflow.toml` and no `job.toml` for each job_folder, please add them after reading the scripts from the workflow, use the docker image `chiral.sakuracr.jp/pocketeer:2025_12_08`
  1. Created `.chiral/job.toml` for each job folder with correct TOML structure (inputs/outputs before sections)
  2. Created `.chiral/workflow.toml` with job dependencies
  3. Created `run.sh` wrapper scripts for each job's Python script
  4. Fixed container reuse by adding `tail -f /dev/null` keep-alive command
  5. Added temp folder execution in headless mode (mirrors TUI behavior)
  6. Added input file copying from dependency outputs to current job folder
  7. Workflow completed successfully: download -> pocket detection -> visualization
- [x] move the parameters from the scripts out from the scripts, define the parameters in `workflow.toml` and `job.toml`, use them as Environment variables, refer to the TUI implementation.
  - for global parameters in workflow.toml: `pdb_id` (replace `pdb_code`)
  - job `02_pocket`: search parameters for `pocketeer.find_pockets` and add them as job parameters.
  - job `03_visualize`: convert the configuration options into parameters
  1. Created `workflow.toml` with global `pdb_id` parameter (default: "4TOS")
  2. Created `02_pocket/job.toml` with 8 find_pockets parameters: r_min, r_max, polar_probe_radius, merge_distance, min_spheres, ignore_hydrogens, ignore_water, ignore_hetero
  3. Created `03_visualize/job.toml` with 4 enum parameters: pocket_style, render_method, representation, output_format
  4. Updated Python scripts to read parameters from environment variables (PARAM\_\* prefix)
  5. Fixed outputs in 02_pocket to include \*.pdb for proper data flow to 03_visualize
  6. Workflow completed successfully with all parameters injected via environment variables
- [x] the default parameters can be changed by adding a new file `params.json` under the job folder, verify the headless flow can be run successfully with customized parameters.
  1. Created `params.json` in `02_pocket/` with customized parameters (r_min=2.5, r_max=7.5, min_spheres=25, etc.)
  2. Created `global_params.json` in workflow root with custom `pdb_id: "1A2B"`
  3. Ran headless workflow successfully - parameters were correctly injected:
     - Global param: Downloaded PDB file "1A2B" instead of default "4TOS"
     - Job params: `r_min=2.5, r_max=7.5, polar_probe_radius=2.0, merge_distance=1.5, min_spheres=25`
  4. Found 35 pockets (more than default due to lower min_spheres threshold)
- [x] show progress when docker is pulling an image
  1. Modified `pull_image()` in `executor.rs` to extract progress from Bollard's `CreateImageInfo`
  2. Progress info includes: layer ID, status (Pulling/Downloading/Extracting), percentage
  3. Example output: `20043066d3d5: Downloading: 52%`, `20043066d3d5: Extracting: 100%`
  4. Also displays digest and final status when download completes
- [x] add another option for `job_config::job::Container.image`, it can be a url or a local file.
  1. Added `ImageSource` enum with three variants: `Registry`, `TarFile`, `SifFile`
  2. Added `Container::get_image_source()` method to detect source type from image string
  3. Detection based on file extension: `.tar` -> TarFile, `.sif` -> SifFile, otherwise -> Registry
  4. Added tests for all three image source types

## Rules for each step

- Some steps will be done manally and they will be marked and highlighted.
- [x] means it has been done.
- After the completion of each step, update "CHANGELOG.md" and the "doc/\*.md" and also "job_config/README.md"
